<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0076)http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/ -->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US"><head profile="http://gmpg.org/xfn/11"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<title> How to Make a Sankey Diagram to Show Flow</title>
<meta name="generator" content="WordPress 3.8">  
<link rel="stylesheet" href="./How to Make a Sankey Diagram to Show Flow_files/style.css" type="text/css" media="screen">
<link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="http://flowingdata.com/feed">
<link rel="pingback" href="http://flowingdata.com/xmlrpc.php">
<link rel="shortcut icon" href="http://flowingdata.com/wp-content/themes/flowingdata-4-8/images/favicon.ico">
<script src="./How to Make a Sankey Diagram to Show Flow_files/quant.js" async="" type="text/javascript"></script><script async="" type="text/javascript" src="http://www.googletagservices.com/tag/js/gpt.js"></script><script type="text/javascript" src="./How to Make a Sankey Diagram to Show Flow_files/jquery-1.4.4.min.js"></script>
<script type="text/javascript">
    var googletag = googletag || {};
    googletag.cmd = googletag.cmd || [];
    (function() {
    var gads = document.createElement('script');
    gads.async = true;
    gads.type = 'text/javascript';
    var useSSL = 'https:' == document.location.protocol;
    gads.src = (useSSL ? 'https:' : 'http:') + 
    '//www.googletagservices.com/tag/js/gpt.js';
    var node = document.getElementsByTagName('script')[0];
    node.parentNode.insertBefore(gads, node);
    })();
    </script>
<script type="text/javascript">
    googletag.cmd.push(function() {
    googletag.defineSlot('/2462688/Sidebar_rectangle', [300, 250], 'div-gpt-ad-1332011316310-2').addService(googletag.pubads());
    googletag.defineSlot('/2462688/Square1', [125, 125], 'div-gpt-ad-1332011316310-3').addService(googletag.pubads());
    googletag.defineSlot('/2462688/Square2', [125, 125], 'div-gpt-ad-1332011316310-4').addService(googletag.pubads());
    googletag.defineSlot('/2462688/Square3', [125, 125], 'div-gpt-ad-1332011316310-5').addService(googletag.pubads());
    googletag.defineSlot('/2462688/Square4', [125, 125], 'div-gpt-ad-1358209090048-5').addService(googletag.pubads());
googletag.defineSlot('/2462688/Bottom_Post', [300, 250], 'div-gpt-ad-1332011316310-0').addService(googletag.pubads());    googletag.pubads().enableSingleRequest();
    googletag.pubads().collapseEmptyDivs();
    googletag.enableServices();
    });
    </script>
<link rel="alternate" type="application/rss+xml" title="FlowingData » How to Make a Sankey Diagram to Show Flow Comments Feed" href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/feed/">
<link rel="stylesheet" id="ws-plugin--s2member-css" href="./How to Make a Sankey Diagram to Show Flow_files/s2member-o.php" type="text/css" media="all">
<script type="text/javascript" src="./How to Make a Sankey Diagram to Show Flow_files/comment-reply.min.js"></script>
<script type="text/javascript" src="./How to Make a Sankey Diagram to Show Flow_files/jquery.js"></script>
<script type="text/javascript" src="./How to Make a Sankey Diagram to Show Flow_files/jquery-migrate.min.js"></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://flowingdata.com/xmlrpc.php?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://flowingdata.com/wp-includes/wlwmanifest.xml">
<link rel="prev" title="Animations in R" href="http://flowingdata.com/2012/04/26/animations-in-r/">
<link rel="next" title="A Very Short History of Data Science" href="http://flowingdata.com/2012/04/26/a-very-short-history-of-data-science/">
<meta name="generator" content="WordPress 3.8">
<link rel="canonical" href="./How to Make a Sankey Diagram to Show Flow_files/How to Make a Sankey Diagram to Show Flow.html">
<link rel="shortlink" href="http://flowingdata.com/?p=23358">
 <script type="text/javascript" src="./How to Make a Sankey Diagram to Show Flow_files/democracy.js"></script><link rel="stylesheet" href="./How to Make a Sankey Diagram to Show Flow_files/basic.css" type="text/css"><link rel="stylesheet" href="./How to Make a Sankey Diagram to Show Flow_files/style(1).css" type="text/css"><link rel="stylesheet" href="./How to Make a Sankey Diagram to Show Flow_files/wp-page-numbers.css" type="text/css" media="screen"><style type="text/css">img#wpstats{display:none}</style><link rel="stylesheet" type="text/css" href="./How to Make a Sankey Diagram to Show Flow_files/shCore.css"><link rel="stylesheet" type="text/css" href="./How to Make a Sankey Diagram to Show Flow_files/shThemeDefault.css"><style type="text/css" id="syntaxhighlighteranchor"></style>
<style>#uwgllhejjyvikzmxrakjttqmjegqkhuxr{border:solid 2px #fff !important;box-sizing:content-box !important;color:#fff !important;display:block !important;height:auto !important;margin:0 !important;opacity:0.9 !important;padding:7px 10px !important;position:fixed !important;visibility:visible !important;width:auto !important;z-index:2147483647 !important;-webkit-border-radius:5px !important;-webkit-box-shadow:0px 0px 20px #000 !important;-webkit-box-sizing:content-box !important;}.uwgllhejjyvikzmxrakjttqmjegqkhuxr-blocked{color:#777 !important;display:inline !important;text-decoration:line-through !important;}#uwgllhejjyvikzmxrakjttqmjegqkhuxr br{display:block !important;}#uwgllhejjyvikzmxrakjttqmjegqkhuxr span{background:transparent !important;}#uwgllhejjyvikzmxrakjttqmjegqkhuxr div{border:0 !important;margin:0 !important;padding:0 !important;width:auto !important;letter-spacing:normal !important;font:13px Arial,Helvetica !important;text-align:left !important;text-shadow:none !important;text-transform:none !important;word-spacing:normal !important;}#uwgllhejjyvikzmxrakjttqmjegqkhuxr a{font-weight:normal !important;background:none !important;text-decoration:underline !important;color:#fff !important;}@media print{#uwgllhejjyvikzmxrakjttqmjegqkhuxr{display:none !important;}}</style></head>
<body style="">
<a name="top"></a>
<div id="topnav">
<div id="topnav-content" class="content">
<div id="login" class="float-right">
<span id="username-meta">Logged in as <a href="http://flowingdata.com/profile/">abresler</a> &nbsp;&nbsp;</span>
<a href="http://flowingdata.com/wp-login.php?action=logout&_wpnonce=d018091d15">Log out</a> </div>
</div>
<div class="clear-line"></div>
</div> 
<div id="header">
<div id="header-content" class="content">
<div id="nav">
<a href="http://flowingdata.com/">
<img src="./How to Make a Sankey Diagram to Show Flow_files/logo.png" class="float-left" scale="0">
</a>
<div id="pages" class="float-right">
<ul>
<li><a href="http://flowingdata.com/membership/">Membership</a></li>
<li><a href="http://flowingdata.com/learning/">Learning</a></li>
<li><a href="https://jobs.flowingdata.com/">Job Board</a></li>
<li><a href="http://flowingdata.com/category/projects/">Projects</a></li>
<li><a href="http://flowingdata.com/about/">About</a></li>
</ul>
</div> 
<div class="clear-line"></div>
</div> 
</div> 
</div> 
<div class="clear-line"></div>
<div id="main-wrapper">
<div id="content-wrapper" class="content">
<div class="post" id="post-23358">
<div id="content" class="single-long">
<div class="entry">
<div class="category">
<a href="http://flowingdata.com/category/tutorials/" title="View all posts in Tutorials" rel="category tag">Tutorials</a> &nbsp;/&nbsp; <a href="http://flowingdata.com/tag/r/" rel="tag">R</a>, <a href="http://flowingdata.com/tag/sankey/" rel="tag">Sankey</a> <span class="members-note"><a href="http://flowingdata.com/members-only">Members Only</a></span> </div>
<h1>How to Make a Sankey Diagram to Show Flow</h1>
<div class="clear-line"></div>
<div class="author">
By <strong>Nathan Yau</strong>
</div> 
<div id="lead-in">
<p class="img-right"><img src="./How to Make a Sankey Diagram to Show Flow_files/sankey-leader.png" class="attachment-long-form-thumb wp-post-image" alt="How to Make a Sankey Diagram" width="425" height="280" src-orig="http://i2.wp.com/flowingdata.com/wp-content/uploads/2012/04/sankey-leader.png?fit=425%2C9999" scale="2"></p>
<div class="entry-excerpt">
These tend to be made ad hoc and are usually pieced together manually, which takes a lot of time. Here's a way to lay the framework in R, so you don't have to do all the work yourself. </div>
<div id="tut-meta">
<div class="button-link"><a href="http://flowingdata.com/wp-content/uploads/2012/04/00-final-sankey.png">Demo</a></div>
<div class="button-link"><a href="http://flowingdata.com/?s2member_file_download=2012/sankey-tutorial.zip">Download Source</a></div>
<div class="clear-line"></div>
</div> 
<div class="clear-line"></div>
</div> 
<div class="entry-content">
<p>The Sankey diagram is a specialized flow diagram that has found its uses every now and then. Originally used to show flow, the method has also found other uses such as in visualizing hierarchies and <a href="http://flowingdata.com/2010/09/29/charted-history-of-airline-mergers/">mergers</a>.</p>
<p><span class="tip">I found <a href="http://biologicalposteriors.blogspot.com/2010/07/sankey-diagrams-in-r.html">one attempt</a> at Sankey diagrams in R, but it was limited to only an input and output, with nothing in between.</span>There are programs specifically made to draw Sankey diagrams, but the ones that I've seen are bulky or don't do a good job. I don't want to download an entire program just for one visualization type, so instead here's a way to do it in R using custom code. </p>
<h2>Setup</h2>
<p>Since this is in R, you need to <a href="http://www.r-project.org/">download it</a>. It's free, open source, and pretty much a one-click install for Mac and Windows. That's the only software you'll need for this tutorial. No packages required.</p>
<p><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/flowingdata.com/?s2member_file_download=2012/sankey-tutorial.zip">Download the source</a>, too and open sankey.R in your favorite text editor. Since this code is custom, there are a lot of brackets and some loops in there. It'll be much easier to follow along with the code open than it would be to type all the code yourself.</p>
<p>Also, if you don't care about the inner workings, you can skip to the bottom to see how to use the function.</p>
<h2>Data Structure</h2>
<p>While Sankey diagrams are typically used to show flow, I find it useful to think of the data in a hierarchy format, like in a tree diagram. </p>
<p><span class="tip">Think of the data that a Sankey diagram shows as a hierarchy.</span><img src="./How to Make a Sankey Diagram to Show Flow_files/tree-diagram.png" alt="" title="tree diagram" class="alignnone size-full wp-image-23679" width="625" height="400" src-orig="http://i2.wp.com/flowingdata.com/wp-content/uploads/2012/04/tree-diagram.png?resize=625%2C400" scale="2"></p>
<p>You have the root, and then there are nodes (or leaves) that come off the root. Then there are leaves that come off of those leaves, so on and so forth. So you can use similar logic to draw a Sankey diagram that you might use to draw a tree diagram. You just draw lines of varying width instead of nodes and edges.</p>
<p>In this tutorial, you'll look at the hierarchy of the <a href="http://www.whitehouse.gov/omb/budget/Overview">2013 discretionary spending</a> for the Department of Education, found in <code>budget2013.csv</code>. There are three columns: name, parent, and value. </p>
<p><span class="tip">This is what the data looks like.</span><img src="./How to Make a Sankey Diagram to Show Flow_files/01budget-data.png" alt="" title="budget data" class="alignnone size-medium wp-image-23461" width="625" height="519" src-orig="http://i0.wp.com/flowingdata.com/wp-content/uploads/2012/04/01budget-data.png?resize=625%2C519" scale="2"></p>
<p>The first is the names of programs such as Investing in Innovation. The second is the parent category, such as Elementary and Secondary Schools, and if a row represents the base of the Sankey — in this case the total proposed discretionary spending for education — then the parent value is left blank. The parent name should match one other name. </p>
<p>For example, the first row represents spending for college and career-ready students. The proposed budget is $14,516 million for the year. The parent is Elementary and Secondary schools, which totals $21,934 million.</p>
<h2>Loading Data</h2>
<p><span class="tip">I like to work with non-simulated data when possible. Fake data tends to be too perfect, and you need to be able to work with inconsistencies eventually. I'd rather do that from the beginning.</span>First things first: load the data in R. There's not much to visualize otherwise. Use <code>read.table()</code> to load the data on discretionary spending for education.</p>
<div id="highlighter_439676" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_439676_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_439676" menu="false" src="http://flowingdata.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="plain">budget &lt;- </code><code class="functions">read.table</code><code class="plain">(</code><code class="string">"budget2013.csv"</code><code class="plain">, header=</code><code class="keyword">TRUE</code><code class="plain">, sep=</code><code class="string">","</code><code class="plain">, as.is=</code><code class="keyword">TRUE</code><code class="plain">)</code></td></tr></tbody></table></div></div></div>
<p></p>
<p>Look at the first couple of rows to make sure the CSV file loaded correctly. There should be a header and three columns.</p>
<div id="highlighter_186573" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_186573_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_186573" menu="false" src="http://flowingdata.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="plain">budget[1:2,]</code></td></tr></tbody></table></div></div></div>
<p></p>
<p>Data? Check. You'll come back to this later.</p>
<p><span class="tip">This is how you create functions in R. The advantage of writing a function over a one-off script is that you can easily reuse this function later on. Just one line of code to make the diagram instead of having to come back to old code to figure out what you have to change.</span>The rest of the code is for a <code>sankey()</code> function. You want to plug <code>budget</code> into a function, and it should spit out a diagram. Here's the start of it. The function will also take the arguments for fill color (<code>col</code>) and whether or not to show labels (<code>showLabels</code>).</p>
<div id="highlighter_301841" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_301841_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_301841" menu="false" src="http://flowingdata.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="plain">sankey &lt;- </code><code class="keyword">function</code><code class="plain">(thedata, col=</code><code class="string">"#821122"</code><code class="plain">, showLabels=</code><code class="keyword">TRUE</code><code class="plain">) {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># Draw the Sankey diagram based on thedata</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div></div></div>
<p></p>
<h3>Sort the Data</h3>
<p>Flows will be displayed from least to greatest depth left to right and least to greatest value top to bottom. The data should be sorted to make this easier. You can require that the <code>sankey()</code> function use only sorted data, but it's more practical to be able to plug the data in as-is. </p>
<p>First though, there are a couple things that you have to keep track of, so create a blank list, <code>yParTop</code> and a blank vector, <code>depths</code>. It'll be more clear what these are used for in a bit. </p>
<div id="highlighter_466657" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_466657_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_466657" menu="false" src="http://flowingdata.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="plain">yParTop &lt;- list()</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="plain">depths &lt;- c()</code></td></tr></tbody></table></div></div></div>
<p></p>
<p>There is also a helper function in sankey.R called <code>findDepth()</code>. This goes outside <code>sankey()</code>. It takes the name of a <code>leaf</code> and a dataframe (that matches the format of <code>budget</code>) and returns the depth of that leaf. For example, the root depth is one, and categories that come right after have a depth of two.</p>
<div id="highlighter_75220" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_75220_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_75220" menu="false" src="http://flowingdata.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="comments"># Helper function: Find depth of leaf.</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="plain">findDepth &lt;- </code><code class="keyword">function</code><code class="plain">(leaf, thedata) {</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>4</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">currDepth &lt;- 1</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>5</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">parent &lt;- thedata[thedata$name == leaf,]$parent</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>6</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="keyword">while</code><code class="plain">(parent != </code><code class="string">''</code><code class="plain">) {</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>7</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>8</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">currDepth &lt;- currDepth + 1</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>9</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">parent &lt;- thedata[thedata$name == parent,]$parent</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>10</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>11</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>12</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">return</code><code class="plain">(currDepth)</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>13</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div></div></div>
<p></p>
<p>Coming back to <code>sankey()</code>, you use <code>findDepth()</code> to calculate how deep each leaf (i.e. row) is. The result is stored as <code>depths</code> and it is appended as a new column to <code>thedata</code>. The maximum depth (<code>maxdepth</code>) and starting total value (<code>startTotal</code>) are also stored for later use.</p>
<div id="highlighter_452893" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_452893_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_452893" menu="false" src="http://flowingdata.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="functions">for </code><code class="plain">(i </code><code class="keyword">in</code> <code class="plain">1:</code><code class="functions">length</code><code class="plain">(thedata[,1])) {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">depths &lt;- </code><code class="functions">c</code><code class="plain">(depths, </code><code class="functions">findDepth</code><code class="plain">(thedata[i,]$name, thedata))</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>4</code></td><td class="content"><code class="plain">thedata$depth &lt;- depths</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>5</code></td><td class="content"><code class="plain">maxdepth &lt;- </code><code class="functions">max</code><code class="plain">(depths)</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>6</code></td><td class="content"><code class="plain">startTotal &lt;- </code><code class="functions">max</code><code class="plain">(thedata$value)</code></td></tr></tbody></table></div></div></div>
<p></p>
<p>Using <code>order()</code>, you sort <code>thedata</code> first by depth, descending, and then by value, ascending. This sorting will make the finished diagram easier to read and draw.</p>
<div id="highlighter_512924" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_512924_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_512924" menu="false" src="http://flowingdata.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="comments"># Sort appropriately for upcoming iteration, first depth then value.</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="plain">thedata &lt;- thedata[</code><code class="functions">with</code><code class="plain">(thedata, </code><code class="functions">order</code><code class="plain">(depth, -value)),]</code></td></tr></tbody></table></div></div></div>
<p></p>
<p>Here's what the data look like now in R.</p>
<p><span class="tip">Data loaded and sorted in R</span><img src="./How to Make a Sankey Diagram to Show Flow_files/02data-sorted.png" alt="" title="data sorted" class="alignnone size-medium wp-image-23467" width="625" height="581" src-orig="http://i0.wp.com/flowingdata.com/wp-content/uploads/2012/04/02data-sorted.png?resize=625%2C581" scale="2"></p>
<h2>Drawing a Sankey Diagram</h2>
<p>The data is prepped, and it's time to draw. Again, from a logic standpoint, you approach the Sankey diagram like you would a tree diagram. You start with the base, and then work your way through each depth until you get to the end.</p>
<p>It might also be helpful to think about the Sankey diagram as a specialized stacked bart chart, but at each depth, you have different categories. Also, each leaf has to be shifted up or down to align with its parent.</p>
<h3>Prep the Space</h3>
<p>If you're familiar with R, you've probably used <code>plot()</code> plenty of times before. Instead of making an actual graph though, you just wanted a blank window for this, and then you'll write your own code to draw a Sankey diagram. Set the plot type, <code>type</code>, to <em>n</em>.</p>
<div id="highlighter_511259" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_511259_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_511259" menu="false" src="http://flowingdata.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="comments"># Get your Sankey on.</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="functions">plot</code><code class="plain">(0, 0, xlim=</code><code class="functions">c</code><code class="plain">(0, maxdepth+1), ylim=</code><code class="functions">c</code><code class="plain">(-startTotal/10, startTotal), type=</code><code class="string">"n"</code><code class="plain">, xlab=</code><code class="string">"depth"</code><code class="plain">, ylab=</code><code class="string">"value"</code><code class="plain">)</code></td></tr></tbody></table></div></div></div>
<p></p>
<p><span class="tip">Blank plot before drawing anything</span><img src="./How to Make a Sankey Diagram to Show Flow_files/03blank-plot.png" alt="" title="blank plot" class="alignnone size-medium wp-image-23552" width="625" height="458" src-orig="http://i0.wp.com/flowingdata.com/wp-content/uploads/2012/04/03blank-plot.png?resize=625%2C458" scale="2"></p>
<h3>Draw the Base</h3>
<p>Now you iterate through each depth with a for loop, starting with the base, a depth of one. At each depth are some number of leaves. <span class="tip">There isn't always a single base, but it makes the logic a little easier for the purposes of this tutorial. If you have a dataset that starts with a multiple bases, a simple workaround is to add them up and use that as the base. You can always remove it later on.</span>At the first depth, it is assumed that there is only one item.</p>
<div id="highlighter_136189" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_136189_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_136189" menu="false" src="http://flowingdata.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="functions">for </code><code class="plain">(i </code><code class="keyword">in</code> <code class="plain">1:maxdepth) {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># Get leaves at current depth i</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>4</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">leaves &lt;- thedata[thedata$depth == i,]</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>5</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">x &lt;- leaves$depth</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>6</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">y &lt;- leaves$value</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>7</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>8</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># Draw a rectangle for each leaf.</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>9</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">for </code><code class="plain">(j </code><code class="keyword">in</code> <code class="plain">1:</code><code class="functions">length</code><code class="plain">(leaves[,1])) {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>10</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># Do something.</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>11</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>12</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div></div></div>
<p></p>
<p>Most of the work will go into the second for loop. At each depth you draw a rectangle for each leaf, and then keep track of the top of each flow, so that you can draw child leaves in the next iteration.</p>
<p>So the first if statement (in the second for loop) checks if the current leaf is a parent. If it is, draw a rectangle of a height equivalent to the leaf's value with <code>rect()</code>. If <code>showLabels</code> is set to TRUE, add one with <code>text()</code> in the midpoint of the rectangle.</p>
<p>The top of the rectangle is stored in <code>yParTop</code> for use in the next iteration. <code>yTop</code> is used to keep track of the highest point at the current depth where there are children. This will be more clear in a couple of steps.</p>
<div id="highlighter_645438" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_645438_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_645438" menu="false" src="http://flowingdata.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="comments"># If first leaf i.e. the root</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="functions">if </code><code class="plain">(leaves[j,]$parent == </code><code class="string">''</code><code class="plain">) {</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>4</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># Draw rectangle from zero to value.</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>5</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">x1 &lt;- i - 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>6</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">y1 &lt;- 0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>7</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">x2 &lt;- i + 0.01&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </code><code class="comments"># Buffer to add overlap</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>8</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">y2 &lt;- startTotal&nbsp;&nbsp;&nbsp; </code><code class="comments"># Padding for top border</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>9</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">rect</code><code class="plain">(x1, y1, x2, y2, col=col, border=col)</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>10</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">lines</code><code class="plain">(</code><code class="functions">c</code><code class="plain">(x1, x2), </code><code class="functions">c</code><code class="plain">(y2, y2), col=</code><code class="string">"#ffffff"</code><code class="plain">, lwd=0.7)</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>11</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>12</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># Add label.</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>13</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">if </code><code class="plain">(showLabels) {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>14</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>15</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># Midpoint of leaf</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>16</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">xMid &lt;- (x1 + x2) / 2</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>17</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">yMid &lt;- (y1 + y2) / 2</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>18</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">text</code><code class="plain">(xMid, yMid, </code><code class="functions">paste</code><code class="plain">(leaves[j,]$name, </code><code class="string">"\n("</code><code class="plain">, leaves[j,]$value, </code><code class="string">")"</code><code class="plain">, sep=</code><code class="string">""</code><code class="plain">), cex=1, col=</code><code class="string">"#000000"</code><code class="plain">)</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>19</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>20</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>21</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># Save location of rectangle top.</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>22</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">yParTop[[leaves[j,]$name]] &lt;- startTotal</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>23</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">yTop &lt;- startTotal</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>24</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>25</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div></div></div>
<p></p>
<p>Here's what you get at the base depth.</p>
<p><span class="tip">The beginnings of a Sankey diagram</span><img src="./How to Make a Sankey Diagram to Show Flow_files/04base-drawn1.png" alt="" title="base drawn" class="alignnone size-medium wp-image-23640" width="625" height="356" src-orig="http://i1.wp.com/flowingdata.com/wp-content/uploads/2012/04/04base-drawn1.png?resize=625%2C356" scale="2"></p>
<h3>Chart the Flows</h3>
<p>The leaves of the base are drawn similarly. You still draw rectangles, but at different heights. The height is based on the y-value of the top end of the parent rectangle and on any previously drawn leaves at the current depth. Notice that in lines 121 and 122 of sankey.R, these values are stored and adjusted in the <code>yParTop</code> list for easy access.</p>
<div id="highlighter_8111" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_8111_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_8111" menu="false" src="http://flowingdata.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="keyword">else</code> <code class="plain">{</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># Draw leaf based on location of parent.</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>4</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">x1 &lt;- i - 1</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>5</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">y1 &lt;- yParTop[[leaves[j,]$parent]]-y[j]</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>6</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">x2 &lt;- i</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>7</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">y2 &lt;- yParTop[[leaves[j,]$parent]]</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>8</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">rect</code><code class="plain">(x1, y1, x2+0.01, y2, col=col, border=col)</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>9</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">lines</code><code class="plain">(</code><code class="functions">c</code><code class="plain">(x1, x2), </code><code class="functions">c</code><code class="plain">(y2, y2), col=</code><code class="string">"#ffffff"</code><code class="plain">, lwd=0.7)</code></td></tr></tbody></table></div></div></div>
<p></p>
<p>As before, if <code>showLabels</code> is set to TRUE, you use <code>text()</code> to put labels at the midpoint of each rectangle.</p>
<div id="highlighter_235430" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_235430_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_235430" menu="false" src="http://flowingdata.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="comments"># Add label.</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">if </code><code class="plain">(showLabels) {</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">xMid &lt;- (x1 + x2) / 2</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>4</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">yMid &lt;- (y1 + y2) / 2</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>5</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">text</code><code class="plain">(xMid, yMid-1, leaves[j,]$name, cex=1.5/i, col=</code><code class="string">"#000000"</code><code class="plain">)</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>6</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">}</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>7</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>8</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># Set y offset.</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>9</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">yTop &lt;- yParTop[[leaves[j,]$parent]]</code></td></tr></tbody></table></div></div></div>
<p></p>
<p><span class="tip">Other flows added at appropriate heights</span><img src="./How to Make a Sankey Diagram to Show Flow_files/05other-flows.png" alt="" title="other flows" class="alignnone size-medium wp-image-23644" width="625" height="357" src-orig="http://i1.wp.com/flowingdata.com/wp-content/uploads/2012/04/05other-flows.png?resize=625%2C357" scale="2"></p>
<p>It's getting there.</p>
<h3>Show End of Flow</h3>
<p><span class="tip">Remember you can always look up documentation by typing a question mark and the function name in the R console e.g. <code>?polygon</code></span>To indicate the end of the flow, use a rectangular shape that points down 45 degrees. Use the good old slope-intercept formula, <em>y = mx + b</em> to figure out coordinates of the four corners. Then plug those coordinates into <code>polygon()</code> to draw the shape at the end of each flow.</p>
<div id="highlighter_975483" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_975483_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_975483" menu="false" src="http://flowingdata.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># Check if leaf has children.</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">if </code><code class="plain">(leaves[j,]$name %</code><code class="keyword">in</code><code class="plain">% thedata$parent) {</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code>&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>4</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># Do nothing for now.</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>5</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>6</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">} </code><code class="keyword">else</code> <code class="plain">{&nbsp;&nbsp;&nbsp; </code><code class="comments"># Current leaf has no children.</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>7</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>8</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># Draw downward shape to show end.</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>9</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">x1 &lt;- i</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>10</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">y1 &lt;- yTop - 1</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>11</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">x2 &lt;- x1 + 0.4</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>12</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">y2 &lt;- y1 - startTotal/10 - 1</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>13</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>14</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">x4 &lt;- x1</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>15</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">y4 &lt;- y1 - y[j] + 1</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>16</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>17</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">m &lt;- (y2 - y1) / (x2 - x1)</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>18</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">b &lt;- y4 - m * x4</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>19</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>20</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">y3 &lt;- y4 - startTotal/10</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>21</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">x3 &lt;- (y3 - b) / m</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>22</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>23</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">polygon</code><code class="plain">(</code><code class="functions">c</code><code class="plain">(x1, x2, x3, x4), </code><code class="functions">c</code><code class="plain">(y1, y2, y3, y4), col=col, border=col)</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>24</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">lines</code><code class="plain">(</code><code class="functions">c</code><code class="plain">(x1, x2), </code><code class="functions">c</code><code class="plain">(y1, y2), col=</code><code class="string">"#ffffff"</code><code class="plain">, lwd=0.7)</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>25</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>26</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">} </code><code class="comments"># @end if leaf has children</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>27</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>28</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="comments"># Store parent offsets for next iteration.</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>29</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">yParTop[[leaves[j,]$name]] &lt;- yParTop[[leaves[j,]$parent]]</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>30</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">yParTop[[leaves[j,]$parent]] &lt;- yParTop[[leaves[j,]$parent]] - y[j]</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>31</code></td><td class="content"><code class="plain">}</code></td></tr></tbody></table></div></div></div>
<p></p>
<p><span class="tip">End of flows shown with downward-faced polygons</span><img src="./How to Make a Sankey Diagram to Show Flow_files/06end-of-flows.png" alt="" title="end of flows" class="alignnone size-medium wp-image-23650" width="625" height="355" src-orig="http://i1.wp.com/flowingdata.com/wp-content/uploads/2012/04/06end-of-flows.png?resize=625%2C355" scale="2"></p>
<p>Notice that a line is drawn on top of each polygon with the <code>lines()</code> function to provide separation. This was also done in the previous step. Without the lines, you wouldn't be able to see the value of each leaf, which you don't want.</p>
<p><span class="tip">Diagram without any lines that separate categories</span><img src="./How to Make a Sankey Diagram to Show Flow_files/07flow-without-separation.png" alt="" title="07flow without separation" class="alignnone size-medium wp-image-23653" width="625" height="358" src-orig="http://i0.wp.com/flowingdata.com/wp-content/uploads/2012/04/07flow-without-separation.png?resize=625%2C358" scale="2"></p>
<p>Finally, it'd also be useful to show any remaining values from each parent. For this particular data, the values of the leaves at each depth add up to the parent, but imagine if you just had the top three categories of discretionary education spending (Pell grants, elementary and secondary programs, and special education). You could either do nothing so that bottom of the rectangle just hangs down to indicate a remainder, or you could draw a downward polygon like you just did to show the end of a flow. To do the latter, you check if the sum of a parent's leaves (i.e. children) is less than the value of the parent. If so, you draw the end shape at the bottom of the leaves.</p>
<div id="highlighter_995711" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_995711_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_995711" menu="false" src="http://flowingdata.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="comments"># Get sum of child leaves, if they exist.</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="plain">childrenSum &lt;- </code><code class="functions">sum</code><code class="plain">(thedata[thedata$parent == leaves[j,]$name,]$value)</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>4</code></td><td class="content"><code class="comments"># If parent leftover after leaves, show remainder.</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>5</code></td><td class="content"><code class="functions">if </code><code class="plain">(childrenSum &lt; yTop) {</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>6</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">x1 &lt;- i</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>7</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">y1 &lt;- yTop - childrenSum</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>8</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">x2 &lt;- x1 + 0.4</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>9</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">y2 &lt;- y1 - startTotal/10</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>10</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>11</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">x4 &lt;- x1</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>12</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">y4 &lt;- yTop - leaves[j,]$value</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>13</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>14</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">m &lt;- (y2 - y1) / (x2 - x1)</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>15</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">b &lt;- y4 - m * x4</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>16</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>17</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">y3 &lt;- y4 - startTotal/10</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>18</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="plain">x3 &lt;- (y3 - b) / m</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>19</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>20</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">polygon</code><code class="plain">(</code><code class="functions">c</code><code class="plain">(x1, x2, x3, x4), </code><code class="functions">c</code><code class="plain">(y1, y2, y3, y4), col=col, border=</code><code class="keyword">NA</code><code class="plain">)</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>21</code></td><td class="content"><code class="spaces">&nbsp;&nbsp;&nbsp;&nbsp;</code><code class="functions">lines</code><code class="plain">(</code><code class="functions">c</code><code class="plain">(x1, x2), </code><code class="functions">c</code><code class="plain">(y1, y2), col=</code><code class="string">"#ffffff"</code><code class="plain">, lwd=0.7)</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>22</code></td><td class="content">&nbsp;</td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>23</code></td><td class="content"><code class="plain">} </code><code class="comments"># @end if childrenSum</code></td></tr></tbody></table></div></div></div>
<p></p>
<p><span class="tip">Remainder of parents shown</span><img src="./How to Make a Sankey Diagram to Show Flow_files/08show-remainder.png" alt="" title="08show remainder" class="alignnone size-medium wp-image-23656" width="625" height="356" src-orig="http://i1.wp.com/flowingdata.com/wp-content/uploads/2012/04/08show-remainder.png?resize=625%2C356" scale="2"></p>
<p>Notice the downward polygon on the bottom.</p>
<p>You might want to show the "Other" category in the data as the remainder instead of a separate flow.</p>
<p><span class="tip">Other category shown with remainder instead of explicitly in data</span><img src="./How to Make a Sankey Diagram to Show Flow_files/09other-category.png" alt="" title="09other category" class="alignnone size-medium wp-image-23657" width="625" height="354" src-orig="http://i1.wp.com/flowingdata.com/wp-content/uploads/2012/04/09other-category.png?resize=625%2C354" scale="2"></p>
<p>This works on greater depths too, say if you wanted to aggregate some of the categories in Elementary and Secondary.</p>
<p><span class="tip">Using remainder to show aggregate of smaller categories</span><img src="./How to Make a Sankey Diagram to Show Flow_files/10deeper-depths.png" alt="" title="10deeper depths" class="alignnone size-medium wp-image-23660" width="625" height="357" src-orig="http://i2.wp.com/flowingdata.com/wp-content/uploads/2012/04/10deeper-depths.png?resize=625%2C357" scale="2"></p>
<p>There you have it: the inner workings of the newly minted <code>sankey()</code> function.</p>
<h2>Usage</h2>
<p><span class="tip">Make sure you change your working directory in R to where you saved the source. Either do this via the menu, Misc → Change Working Directory or with <code>setwd()</code></span>Since the code is wrapped up nicely in a function, you don't even have to look at the code anymore (unless you want to make changes).</p>
<div id="highlighter_643661" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_643661_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_643661" menu="false" src="http://flowingdata.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="plain">budget &lt;- </code><code class="functions">read.table</code><code class="plain">(</code><code class="string">"budget2013.csv"</code><code class="plain">, header=</code><code class="keyword">TRUE</code><code class="plain">, sep=</code><code class="string">","</code><code class="plain">, as.is=</code><code class="keyword">TRUE</code><code class="plain">)</code></td></tr></tbody></table></div><div class="line alt2"><table><tbody><tr><td class="number"><code>2</code></td><td class="content"><code class="functions">source</code><code class="plain">(</code><code class="string">"sankey.R"</code><code class="plain">)</code></td></tr></tbody></table></div><div class="line alt1"><table><tbody><tr><td class="number"><code>3</code></td><td class="content"><code class="functions">sankey</code><code class="plain">(budget)</code></td></tr></tbody></table></div></div></div>
<p></p>
<p>In the above, you just pass the data, stored in <code>budget</code> as the main argument, but it also takes two other arguments: color and whether or not to show labels. By default, the color is dark red and labels are shown. But you can just as easily make it black with no labels.</p>
<div id="highlighter_625380" class="syntaxhighlighter  "><div class="bar"><div class="toolbar"><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#viewSource" title="view source" class="item viewSource" style="width: 16px; height: 16px;">view source</a><div class="item copyToClipboard"><embed width="16" height="16" id="highlighter_625380_clipboard" type="application/x-shockwave-flash" title="copy to clipboard" allowscriptaccess="always" wmode="transparent" flashvars="highlighterId=highlighter_625380" menu="false" src="http://flowingdata.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf"></div><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#printSource" title="print" class="item printSource" style="width: 16px; height: 16px;">print</a><a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#about" title="?" class="item about" style="width: 16px; height: 16px;">?</a></div></div><div class="lines"><div class="line alt1"><table><tbody><tr><td class="number"><code>1</code></td><td class="content"><code class="functions">sankey</code><code class="plain">(budget, col=</code><code class="string">"black"</code><code class="plain">, showLabels=</code><code class="keyword">FALSE</code><code class="plain">)</code></td></tr></tbody></table></div></div></div>
<p></p>
<p><span class="tip">Use <code>col</code> and <code>showLabels</code> to change the look of the diagram</span><img src="./How to Make a Sankey Diagram to Show Flow_files/12additional-parameters.png" alt="" title="12additional parameters" class="alignnone size-medium wp-image-23665" width="625" height="357" src-orig="http://i0.wp.com/flowingdata.com/wp-content/uploads/2012/04/12additional-parameters.png?resize=625%2C357" scale="2"></p>
<p>Remember that to use this with your own data, your dataset has to follow the format of budget2013.csv. One column is the name, another is the parents, and the last is values. Parent names have to match one of the leaf names.</p>
<p>You can of course save the output as a PDF and <a href="http://flowingdata.com/2012/02/28/how-to-edit-r-plots-by-hand-in-inkscape/">edit it in Inkscape</a>, Illustrator, or some other vector-editing software.</p>
<h2>Wrapping Up</h2>
<p>At the end of the day, this is all about drawing shapes and figuring out where to draw them. Just a bunch of rectangles and parallelograms.</p>
<p><span class="tip">A bunch of shapes placed strategically</span><img src="./How to Make a Sankey Diagram to Show Flow_files/11just-shapes.png" alt="" title="just shapes" class="alignnone size-medium wp-image-23671" width="625" height="356" src-orig="http://i1.wp.com/flowingdata.com/wp-content/uploads/2012/04/11just-shapes.png?resize=625%2C356" scale="2"></p>
<p>So creating custom graphics in R isn't that crazy. You just have to know what you want to draw. Start with the base and a single iteration, and then go through the loop.</p>
<p>For practice, some possible extensions to this simple function: using bezier curves to show endings and connections, improvement of label placement so that it's not so cluttered towards the bottom, or allowing multiple inputs from the beginning. Maybe make the end of flows point up on the top half and point down on the bottom half. Hack away.</p>
<div class="clear-line"></div>
</div> 
</div> 
<div class="clear-line"></div>
<div id="end"></div>
 
<span id="comments"></span>
<div style="width:625px">
<div id="comments-block">
<h2>6 Comments</h2>
<ul class="commentlist">
<li class="comment byuser comment-author-jwhendy even thread-even depth-1" id="li-comment-119341">
<div id="comment-119341" class="">
<div class="avatar">
<img alt="" src="./How to Make a Sankey Diagram to Show Flow_files/fbc6ae47ba04ddad05bdfa0a5f106d3e" class="avatar avatar-50 photo" height="50" width="50" originals="50" src-orig="http://1.gravatar.com/avatar/fbc6ae47ba04ddad05bdfa0a5f106d3e?s=50&amp;d=http%3A%2F%2Fflowingdata.com%2Fwp-content%2Fthemes%2Fflowingdata-4-8%2Fimages%2Fblank-square.png%3Fs%3D50&amp;r=PG" scale="2"> </div> 
<div class="comment-content">
<div class="comment-author vcard">
<cite class="fn">John Henderson</cite> <span class="comment-meta">— <a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#comment-119341">April 30, 2012 at 8:45 pm</a>
</span>
</div>
<div class="comment-text"><p>Should the first line, “budget &lt;- read.table(…)" be "thedata &lt;- read.table(…)"?</p>
</div>
<div class="reply">
</div>
</div> 
<div class="clear-line"></div>
</div>
<ul class="children">
<li class="comment byuser comment-author-nathany bypostauthor odd alt depth-2" id="li-comment-119344">
<div id="comment-119344" class="flowingdata-author">
<div class="avatar">
<img alt="" src="./How to Make a Sankey Diagram to Show Flow_files/a61decc5c78c05770cb107e4c5cbbb33" class="avatar avatar-50 photo" height="50" width="50" originals="50" src-orig="http://0.gravatar.com/avatar/a61decc5c78c05770cb107e4c5cbbb33?s=50&amp;d=http%3A%2F%2Fflowingdata.com%2Fwp-content%2Fthemes%2Fflowingdata-4-8%2Fimages%2Fblank-square.png%3Fs%3D50&amp;r=PG" scale="2"> </div> 
<div class="comment-content">
<div class="comment-author vcard">
<cite class="fn"><a href="http://twitter.com/flowingdata" rel="external nofollow" class="url">Nathan Yau</a></cite> <span class="comment-meta">— <a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#comment-119344">April 30, 2012 at 11:47 pm</a>
</span>
</div>
<div class="comment-text"><p>If this were a standalone script, yes, it’d be <code>thedata</code>, but this is a function, so in this case, <code>thedata</code> is an argument to the <code>sankey()</code> function.</p>
</div>
<div class="reply">
</div>
</div> 
<div class="clear-line"></div>
</div>
</li> 
<li class="comment byuser comment-author-nathany bypostauthor even depth-2" id="li-comment-119345">
<div id="comment-119345" class="flowingdata-author">
<div class="avatar">
<img alt="" src="./How to Make a Sankey Diagram to Show Flow_files/a61decc5c78c05770cb107e4c5cbbb33" class="avatar avatar-50 photo" height="50" width="50" originals="50" src-orig="http://0.gravatar.com/avatar/a61decc5c78c05770cb107e4c5cbbb33?s=50&amp;d=http%3A%2F%2Fflowingdata.com%2Fwp-content%2Fthemes%2Fflowingdata-4-8%2Fimages%2Fblank-square.png%3Fs%3D50&amp;r=PG" scale="2"> </div> 
<div class="comment-content">
<div class="comment-author vcard">
<cite class="fn"><a href="http://twitter.com/flowingdata" rel="external nofollow" class="url">Nathan Yau</a></cite> <span class="comment-meta">— <a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#comment-119345">April 30, 2012 at 11:54 pm</a>
</span>
</div>
<div class="comment-text"><p>p.s. check out the usage in the next to last section.</p>
</div>
<div class="reply">
</div>
</div> 
<div class="clear-line"></div>
</div>
<ul class="children">
<li class="comment byuser comment-author-jwhendy odd alt depth-3" id="li-comment-119357">
<div id="comment-119357" class="">
<div class="avatar">
<img alt="" src="./How to Make a Sankey Diagram to Show Flow_files/fbc6ae47ba04ddad05bdfa0a5f106d3e" class="avatar avatar-50 photo" height="50" width="50" originals="50" src-orig="http://1.gravatar.com/avatar/fbc6ae47ba04ddad05bdfa0a5f106d3e?s=50&amp;d=http%3A%2F%2Fflowingdata.com%2Fwp-content%2Fthemes%2Fflowingdata-4-8%2Fimages%2Fblank-square.png%3Fs%3D50&amp;r=PG" scale="2"> </div> 
<div class="comment-content">
<div class="comment-author vcard">
<cite class="fn">John Henderson</cite> <span class="comment-meta">— <a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#comment-119357">May 1, 2012 at 4:52 am</a>
</span>
</div>
<div class="comment-text"><p>Whoops. I got to eager following along in an R session and was confused not seeing the budget object ever show up again. I also hadn’t gotten to your usage section on the larger vision… it all makes sense now :)</p>
</div>
<div class="reply">
</div>
</div> 
<div class="clear-line"></div>
</div>
</li> 
<li class="comment byuser comment-author-nathany bypostauthor even depth-3" id="li-comment-119381">
<div id="comment-119381" class="flowingdata-author">
<div class="avatar">
<img alt="" src="./How to Make a Sankey Diagram to Show Flow_files/a61decc5c78c05770cb107e4c5cbbb33" class="avatar avatar-50 photo" height="50" width="50" originals="50" src-orig="http://0.gravatar.com/avatar/a61decc5c78c05770cb107e4c5cbbb33?s=50&amp;d=http%3A%2F%2Fflowingdata.com%2Fwp-content%2Fthemes%2Fflowingdata-4-8%2Fimages%2Fblank-square.png%3Fs%3D50&amp;r=PG" scale="2"> </div> 
<div class="comment-content">
<div class="comment-author vcard">
<cite class="fn"><a href="http://twitter.com/flowingdata" rel="external nofollow" class="url">Nathan Yau</a></cite> <span class="comment-meta">— <a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#comment-119381">May 1, 2012 at 2:48 pm</a>
</span>
</div>
<div class="comment-text"><p>Glad to help :)</p>
</div>
<div class="reply">
</div>
</div> 
<div class="clear-line"></div>
</div>
</li> 
</ul> 
</li> 
</ul> 
</li> 
<li class="comment byuser comment-author-tormod-boegmail-com odd alt thread-odd thread-alt depth-1" id="li-comment-128304">
<div id="comment-128304" class="">
<div class="avatar">
<img alt="" src="./How to Make a Sankey Diagram to Show Flow_files/0f70054d210690cf72a6f0bd3cf286e1" class="avatar avatar-50 photo" height="50" width="50" originals="50" src-orig="http://0.gravatar.com/avatar/0f70054d210690cf72a6f0bd3cf286e1?s=50&amp;d=http%3A%2F%2Fflowingdata.com%2Fwp-content%2Fthemes%2Fflowingdata-4-8%2Fimages%2Fblank-square.png%3Fs%3D50&amp;r=PG" scale="2"> </div> 
<div class="comment-content">
<div class="comment-author vcard">
<cite class="fn">Tormod Bøe</cite> <span class="comment-meta">— <a href="http://flowingdata.com/2012/04/26/how-to-make-a-sankey-diagram-to-show-flow/#comment-128304">July 3, 2012 at 11:26 pm</a>
</span>
</div>
<div class="comment-text"><p>Dear Nathan, thanks for the excellent tutorial(s). Are you aware of any appropriate techniques to visualize participant flow through a longitudinal study with n waves? I am thinking that this technique could be used to visualize drop-out from the first wave and onwards towards wave n, but it would not allow for inclusion of new participants joining the study in for example wave 2, 3, or 4. Could the code be adapted for this purpose?</p>
</div>
<div class="reply">
</div>
</div> 
<div class="clear-line"></div>
</div>
</li> 
</ul>
</div> 
</div>
</div>
</div> 
</div> 
</div> 
<div id="footer">
<div id="footer-container" class="content">
<div class="float-left" style="width:32%;margin-right:5%;">
<div id="about" class="sec">
<h3>About</h3>
<p>FlowingData explores how designers, statisticians, and computer scientists are using data to understand ourselves better — mainly through data visualization.</p>
<p>As for me, I'm Nathan Yau, and I have a PhD in statistics, with a background in eating.</p>
<p><a href="http://flowingdata.com/about/">More...</a></p>
</div>
</div>
<div class="float-left" style="width:36%;margin-right:5%;">
<div id="book-single" class="sec">
<h3>Books</h3>
<ul id="books" style="margin-bottom:0">
<li>
<a href="http://flowingdata.com/data-points/"><img src="./How to Make a Sankey Diagram to Show Flow_files/DataPoints60x75.png" title="Data Points" class="img-left" style="margin-bottom:0" scale="0"><strong>Data Points</strong><br>Visualization that Means Something</a><br>
<div class="clear-line"></div>
</li>
<li><a href="http://flowingdata.com/visualize-this/"><img src="./How to Make a Sankey Diagram to Show Flow_files/flowingdata60x79.jpg" title="Visualize This" class="img-left" style="margin-bottom:0" scale="0"><strong>Visualize This</strong><br>The FlowingData Guide to Design, Visualization, and Statistics</a><br>
<div class="clear-line"></div>
</li>
</ul>
</div> 
</div>
<div class="float-left" style="width:22%">
<div id="follow" class="sec">
<h3>Follow</h3>
<p>
<a href="http://twitter.com/flowingdata">Twitter</a> &nbsp;•&nbsp;
<a href="http://facebook.com/flowingdata">Facebook</a> &nbsp;•&nbsp;
<a href="http://eepurl.com/icL0o">Email</a> &nbsp;•&nbsp;
<a href="http://flowingdata.com/feed">RSS</a>
</p>
</div>
<div id="misc" class="sec">
<h3>Miscellaneous</h3>
<a href="http://flowingdata.com/contact">Contact</a> &nbsp;•&nbsp;
<a href="http://flowingdata.com/advertise">Sponsorship</a> &nbsp;•&nbsp;
<a href="http://flowingdata.bigcartel.com/">Shop</a><a>
</a></div><a>
</a></div><a>
<div class="clear-line"></div>
</a></div><a> 
</a></div><a> 
</a><div id="bottom"><a>
Unless otherwise noted, graphics and words by me are licensed under </a><a href="http://creativecommons.org/licenses/by-nc/3.0/us/">Creative Commons BY-NC</a>. Contact original authors for everything else.
</div>
 
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script><script src="./How to Make a Sankey Diagram to Show Flow_files/ga.js" type="text/javascript"></script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-865100-4");
pageTracker._initData();
pageTracker._trackPageview();
</script>
<script type="text/javascript" src="./How to Make a Sankey Diagram to Show Flow_files/shCore.js"></script>
<script type="text/javascript" src="./How to Make a Sankey Diagram to Show Flow_files/shBrushR.js"></script>
<script type="text/javascript" src="./How to Make a Sankey Diagram to Show Flow_files/shBrushPlain.js"></script>
<script type="text/javascript">
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "http://flowingdata.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/styles/shCore.css?ver=2.1.364";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "http://flowingdata.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/styles/shThemeDefault.css?ver=2.1.364";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.clipboardSwf = 'http://flowingdata.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter2/scripts/clipboard.swf';
	SyntaxHighlighter.config.strings.expandSource = 'show source';
	SyntaxHighlighter.config.strings.viewSource = 'view source';
	SyntaxHighlighter.config.strings.copyToClipboard = 'copy to clipboard';
	SyntaxHighlighter.config.strings.copyToClipboardConfirmation = 'The code is in your clipboard now';
	SyntaxHighlighter.config.strings.print = 'print';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.all();
</script>
<script type="text/javascript" src="./How to Make a Sankey Diagram to Show Flow_files/photon.js"></script>
<script type="text/javascript" src="./How to Make a Sankey Diagram to Show Flow_files/devicepx-jetpack.js"></script>
<script type="text/javascript" src="./How to Make a Sankey Diagram to Show Flow_files/s2member-o(1).php"></script>
<script src="./How to Make a Sankey Diagram to Show Flow_files/e-201350.js" type="text/javascript"></script>
<script type="text/javascript">
	st_go({v:'ext',j:'1:2.7',blog:'1938889',post:'23358',tz:'-8'});
	var load_cmc = function(){linktracker_init(1938889,23358,2);};
	if ( typeof addLoadEvent != 'undefined' ) addLoadEvent(load_cmc);
	else load_cmc();
	</script><img id="wpstats" src="./How to Make a Sankey Diagram to Show Flow_files/g.gif" alt="" scale="0">
</body><style type="text/css">embed[type*="application/x-shockwave-flash"],embed[src*=".swf"],object[type*="application/x-shockwave-flash"],object[codetype*="application/x-shockwave-flash"],object[src*=".swf"],object[codebase*="swflash.cab"],object[classid*="D27CDB6E-AE6D-11cf-96B8-444553540000"],object[classid*="d27cdb6e-ae6d-11cf-96b8-444553540000"],object[classid*="D27CDB6E-AE6D-11cf-96B8-444553540000"]{	display: none !important;}</style></html>